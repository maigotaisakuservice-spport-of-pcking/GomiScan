<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ã”ã¿AIç®¡ç†ãƒ‘ãƒãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1em; }
    h1, h2 { color: #2c3e50; }
    input, button, select { margin: 0.3em 0; padding: 0.4em; width: 100%; }
    .hidden { display: none; }
    #logTable { width: 100%; border-collapse: collapse; }
    #logTable td, #logTable th { border: 1px solid #aaa; padding: 4px; }
  </style>
</head>
<body>
  <h1>ã”ã¿AIç®¡ç†</h1>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="step1">
    <h2>ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆPINï¼‰</h2>
    <input type="text" id="pinInput" placeholder="5æ¡ã®PIN">
    <button onclick="verifyPIN()">æ¬¡ã¸</button>
    <p id="error1" style="color:red;"></p>
  </div>

  <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› -->
  <div id="step2" class="hidden">
    <h2 id="tenantTitle"></h2>
    <p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
    <input type="password" id="pwInput">
    <button onclick="verifyPassword()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <p id="error2" style="color:red;"></p>
  </div>

  <!-- ç®¡ç†ç”»é¢ -->
  <div id="main" class="hidden">
    <h2>ç®¡ç†ãƒšãƒ¼ã‚¸</h2>
    <p><b id="tenantNameLabel"></b></p>
    <input type="file" id="imageInput">
    <button onclick="analyzeImage()">ã”ã¿åˆ†é¡</button>
    <p id="scanResult"></p>

    <h3>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h3>
    <button onclick="addSchedule()">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¿½åŠ </button>

    <h3>ãƒ­ã‚°</h3>
    <table id="logTable"></table>

    <h3>çµ±è¨ˆ</h3>
    <p id="stats"></p>

    <h3>é€šçŸ¥</h3>
    <button onclick="sendTeams()">Teamsã«é€šçŸ¥</button>
    <button onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </div>

  <!-- æ–°è¦ç™»éŒ² -->
  <hr>
  <h2>æ–°è¦ç™»éŒ²</h2>
  <input id="regName" placeholder="ãƒ†ãƒŠãƒ³ãƒˆå">
  <input id="regPin" placeholder="5æ¡PIN">
  <input id="regPassword" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <input id="regWebhook" placeholder="Teams Webhook (ä»»æ„)">
  <button onclick="register()">ç™»éŒ²</button>
  <p id="regError" style="color:red;"></p>

  <!-- Firebase & TensorFlow.js & Logic -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
  <script>
    const config = {
      apiKey: "AIzaSyCSLAUpLPnuFPqEvIbF7qcQBygHii6EigI",
      authDomain: "gomiscan-pcdaimaou.firebaseapp.com",
      projectId: "gomiscan-pcdaimaou",
      storageBucket: "gomiscan-pcdaimaou.firebasestorage.app",
      messagingSenderId: "802767868691",
      appId: "1:802767868691:web:000fea632524bce9a340e6"
    };
    firebase.initializeApp(config);
    const db = firebase.firestore();
    let tenant = null, tenantId = null;

    // ã‚¹ãƒ†ãƒƒãƒ—1 â†’ PINå…¥åŠ›
    async function verifyPIN() {
      const pin = document.getElementById("pinInput").value.trim();
      const snap = await db.collection("tenants").where("pin", "==", pin).get();
      if (snap.empty) return document.getElementById("error1").textContent = "èªè¨¼å¤±æ•—";

      tenantId = snap.docs[0].id;
      tenant = snap.docs[0].data();

      document.getElementById("tenantTitle").textContent = "ã€" + tenant.name + "ã€‘";
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("step2").classList.remove("hidden");
    }

    async function verifyPassword() {
      const inputPw = document.getElementById("pwInput").value;
      if (tenant.password !== inputPw) {
        document.getElementById("error2").textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
        return;
      }
      document.getElementById("tenantNameLabel").textContent = tenant.name;
      document.getElementById("step2").classList.add("hidden");
      document.getElementById("main").classList.remove("hidden");
      loadLogs();
    }

    async function register() {
      const name = regName.value.trim(), pin = regPin.value.trim(), pw = regPassword.value, hook = regWebhook.value;
      if (pin.length !== 5 || name === "" || pw.length < 4) return regError.textContent = "å…¥åŠ›ä¸å‚™";
      const dup = await db.collection("tenants").where("pin", "==", pin).get();
      if (!dup.empty) return regError.textContent = "PINé‡è¤‡";
      await db.collection("tenants").add({ name, pin, password: pw, webhook: hook });
      alert("ç™»éŒ²å®Œäº†");
    }

    async function analyzeImage() {
      const input = imageInput.files[0];
      if (!input) return alert("ç”»åƒã‚’é¸æŠ");
      scanResult.textContent = "åˆ¤å®šä¸­...";

      const reader = new FileReader();
      reader.onload = async () => {
        const img = new Image();
        img.src = reader.result;
        img.onload = async () => {
          const model = await mobilenet.load();
          const result = await model.classify(img);
          const top = result[0];
          scanResult.textContent = `åˆ†é¡: ${top.className} (${(top.probability * 100).toFixed(1)}%)`;

          await db.collection("logs").add({
            tenantId, result: top.className, prob: top.probability,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          });
          loadLogs();

          if (tenant.webhook?.startsWith("https://")) {
            fetch(tenant.webhook, {
              method: "POST", headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text: `ğŸ§¾ã”ã¿åˆ†é¡: ${top.className} (${(top.probability * 100).toFixed(1)}%)` })
            });
          }
        };
      };
      reader.readAsDataURL(input);
    }

    async function addSchedule() {
      const s = prompt("æ›œæ—¥å");
      if (!s) return;
      await db.collection("schedule").add({
        tenantId, day: s, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
      alert("ç™»éŒ²ã—ã¾ã—ãŸ");
    }

    async function loadLogs() {
      const snap = await db.collection("logs")
        .where("tenantId", "==", tenantId)
        .orderBy("timestamp", "desc").limit(10).get();

      let html = "<tr><th>æ™‚é–“</th><th>åˆ†é¡</th><th>ç¢ºç‡</th></tr>";
      let countMap = {};
      snap.forEach(doc => {
        const d = doc.data();
        const t = d.timestamp?.toDate().toLocaleString();
        html += `<tr><td>${t}</td><td>${d.result}</td><td>${(d.prob * 100).toFixed(1)}%</td></tr>`;
        countMap[d.result] = (countMap[d.result] || 0) + 1;
      });
      logTable.innerHTML = html;

      let statsText = "";
      for (const k in countMap) {
        statsText += `${k}: ${countMap[k]}å›\n`;
      }
      stats.textContent = statsText || "ãƒ‡ãƒ¼ã‚¿ãªã—";
    }

    function sendTeams() {
      if (!tenant.webhook) return alert("Webhookæœªè¨­å®š");
      fetch(tenant.webhook, {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: "ğŸ”” ãƒ†ã‚¹ãƒˆé€šçŸ¥ - " + new Date().toLocaleString() })
      });
    }

    function logout() {
      tenant = null;
      tenantId = null;
      location.reload();
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    window.addEventListener('load', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(console.error);
      }
    });
  </script>
</body>
</html>
